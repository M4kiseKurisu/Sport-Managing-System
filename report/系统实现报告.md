# 系统实现报告



## 一、系统结构设计
我们的系统采用前后端与数据库的分离的架构。数据库作为数据的存储和管理中心，后端利用存储过程或直接执行SQL命令与数据库交互，并将数据传递给前端。后端同时负责接收、处理前端请求，并将请求转发至数据库。前端则专注于用户界面的展示和用户交互，将数据库中的数据呈现给用户，并接收用户对数据的修改请求，将其传递给后端处理。具体实现环境包括。


## 二、数据库基本表的定义

在后端数据库实现中，我们选择采用 Django 中的 ORM 技术，在 `models.py` 文件中定义了 7 个实体表和 11 个联系表，这些表的结构和关系都通过类继承 `models.Model` 来定义，并且利用 ORM 提供的语法来定义了数据库表的类型、约束和关系。通过 ORM，能够以面向对象的方式来操作数据库，简化了数据库操作的编程过程，并提高了开发效率。

### 2.1 实体表

**用户表：** 管理用户个人信息。

|  属性名  |     字段名     |   数据类型   |       约束       |
| :------: | :------------: | :----------: | :--------------: |
|    ID    |      uid       |     int      |   PRIMARY KEY    |
|   账号   |    account     | varchar(32)  | NOT NULL、UNIQUE |
|   密码   |    password    | varchar(32)  |     NOT NULL     |
|   姓名   |   user_name    | varchar(10)  |     NOT NULL     |
|   性别   |  user_gender   |   smallint   |     NOT NULL     |
|   年龄   |    user_age    |     int      |     NOT NULL     |
| 个人签名 | user_signature | varchar(128) |     NOT NULL     |
| 电话号码 |  phone_number  |    bigint    | NOT NULL、UNIQUE |
|   邮箱   |     email      | varchar(32)  | NOT NULL、UNIQUE |
|   头像   |    picture     | varchar(100) |                  |

```python
class User(models.Model):
    """ 用户实体表 """
    USER_GENDER = (
        (0, '女'),
        (1, '男'),
    )
    uid = models.IntegerField(primary_key=True)
    account = models.CharField(max_length=32, unique=True)
    password = models.CharField(max_length=32)
    user_name = models.CharField(max_length=10)
    user_age = models.IntegerField()
    user_gender = models.SmallIntegerField(choices=USER_GENDER)
    phone_number = models.BigIntegerField(unique=True)
    email = models.EmailField(max_length=32, unique=True)
    user_signature = models.CharField(max_length=128, default="", blank=True)
    picture = models.ImageField(upload_to='images/user/', storage=ImageStorage(), null=True)
```



**团体表：** 管理团体的基本信息。

|  属性名  |   字段名   |   数据类型   |       约束       |
| :------: | :--------: | :----------: | :--------------: |
|    ID    |    gid     |     int      |   PRIMARY KEY    |
|   名称   | group_name | varchar(32)  | NOT NULL、UNIQUE |
|   描述   | group_desc | varchar(128) |     NOT NULL     |
| 团体图片 |  picture   | varchar(100) |                  |
| 人数限制 |  maximum   |     int      |     NOT NULL     |
| 成员人数 |  capacity  |     int      |     NOT NULL     |
|   标签   |    tag     | varchar(32)  |     NOT NULL     |
|  创建人  |  creator   |     int      |   FOREIGN KEY    |

```python
class Group(models.Model):
    """ 团体实体表 """
    gid = models.IntegerField(primary_key=True)
    creator = models.ForeignKey(User, on_delete=models.CASCADE)
    group_name = models.CharField(max_length=32, unique=True)
    group_desc = models.CharField(max_length=128)
    tag = models.CharField(max_length=32)
    maximum = models.IntegerField()
    capacity = models.IntegerField()
    picture = models.ImageField(upload_to='images/group/', storage=ImageStorage(), null=True)
```



**器材表：** 管理器材实体的基本信息。

|  属性名  |  字段名  |   数据类型   |       约束       |
| :------: | :------: | :----------: | :--------------: |
|    ID    |   eid    |     int      |   PRIMARY KEY    |
|   类别   | category | varchar(32)  | NOT NULL、UNIQUE |
|   数量   |  amount  |     int      |     NOT NULL     |
| 器材图片 | picture  | varchar(100) |                  |

```python
class Equipment(models.Model):
    """ 器材实体表 """
    eid = models.IntegerField(primary_key=True)
    category = models.CharField(max_length=32, unique=True)
    amount = models.IntegerField(default=0)
    picture = models.ImageField(upload_to='images/equipment/', storage=ImageStorage(), null=True)
```



**场地表：** 管理场地的基本信息。

|  属性名  |   字段名   |  数据类型   |       约束       |
| :------: | :--------: | :---------: | :--------------: |
|    ID    |    fid     |     int     |   PRIMARY KEY    |
|   位置   |  location  | varchar(32) | NOT NULL、UNIQUE |
|   类别   |  category  | varchar(16) |     NOT NULL     |
| 开始时间 | open_time  |   time(6)   |     NOT NULL     |
| 结束时间 | close_time |   time(6)   |     NOT NULL     |
| 项目限制 |   limit    | tinyint(1)  |     NOT NULL     |

```python
class Field(models.Model):
    """ 运动场地实体表 """
    fid = models.IntegerField(primary_key=True)
    location = models.CharField(max_length=32, unique=True)
    category = models.CharField(max_length=16, db_index=True)
    limit = models.BooleanField()
    open_time = models.TimeField()
    close_time = models.TimeField()
```



**活动表：** 管理活动基本信息。

|    属性名    |    字段名    |   数据类型   |    约束     |
| :----------: | :----------: | :----------: | :---------: |
|      ID      |     aid      |     int      | PRIMARY KEY |
|   活动名称   |     name     | varchar(32)  |  NOT NULL   |
|   活动描述   |     desc     | varchar(128) |  NOT NULL   |
|   活动图片   |   picture    | varchar(100) |             |
| 活动人数限制 |   maximum    |     int      |  NOT NULL   |
|   参与人数   |   capacity   |     int      |  NOT NULL   |
|   活动类型   |   category   | varchar(32)  |  NOT NULL   |
|     标签     |     tags     | varchar(128) |  NOT NULL   |
|  创建者类型  | creator_type |   smallint   |  NOT NULL   |
|    获赞数    |    favor     |     int      |  NOT NULL   |
|    私有性    |   private    |  tinyint(1)  |  NOT NULL   |

```python
class Activity(models.Model):
    """ 活动项目实体表 """
    TYPE = (
        (0, "个人"),
        (1, "团体"),
    )
    aid = models.IntegerField(primary_key=True)
    type = models.SmallIntegerField(choices=TYPE, db_index=True)
    name = models.CharField(max_length=32, db_index=True)
    desc = models.CharField(max_length=128)
    category = models.CharField(max_length=32, db_index=True)
    tags = models.CharField(max_length=128)
    maximum = models.IntegerField()
    capacity = models.IntegerField()
    favor = models.IntegerField()
    picture = models.ImageField(upload_to='images/activity/', storage=ImageStorage(), null=True)
    private = models.BooleanField()
```



**通知表：** 管理系统通知的基本数据。

|  属性名  |  字段名  |   数据类型   |    约束     |
| :------: | :------: | :----------: | :---------: |
|    ID    |   nid    |     int      | PRIMARY KEY |
| 通知时间 |   time   | datetime(6)  |  NOT NULL   |
| 通知内容 |   text   | varchar(128) |  NOT NULL   |
| 通知对象 | receiver |     int      | FOREIGN KEY |

```python
class Notice(models.Model):
    """ 系统通知表 """
    nid = models.IntegerField(primary_key=True)
    time = models.DateTimeField(auto_now_add=True, db_index=True)
    text = models.CharField(max_length=128)
    receiver = models.ForeignKey(User, on_delete=models.CASCADE)
```



**动态表：** 管理用户发表的动态信息。

|  属性名  |  字段名  |   数据类型   |    约束     |
| :------: | :------: | :----------: | :---------: |
|    ID    |   sid    |     int      | PRIMARY KEY |
| 发布时间 |   time   | datetime(6)  |  NOT NULL   |
| 发布文本 |   text   | varchar(512) |  NOT NULL   |
| 发布图片 | picture  | varchar(100) |             |
|  获赞数  |  favor   |     int      |  NOT NULL   |
|  私有性  | private  |   smallint   |  NOT NULL   |
| 所属用户 |   user   |     int      | FOREIGN KEY |
| 关联活动 | activity |     int      | FOREIGN KEY |

```python
class Stream(models.Model):
    """ 动态表 """
    PRIVACY = (
        (0, "仅自己可见"),
        (1, "好友可见"),
        (2, "所有人可见"),
    )
    sid = models.IntegerField(primary_key=True)
    time = models.DateTimeField(auto_now_add=True, db_index=True)
    text = models.CharField(max_length=512)
    picture = models.ImageField(upload_to='images/stream/', storage=ImageStorage(), null=True)
    favor = models.IntegerField(default=0)
    private = models.SmallIntegerField(choices=PRIVACY)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    activity = models.ForeignKey(Activity, on_delete=models.CASCADE)
```



### 2.2 联系表

由于 ORM 不支持多个字段共同作为主键，因此没有指定主键的表会自动添加一个自增的 id 字段。

**团体成员表：** 记录团体的成员信息。

|  属性名  | 字段名 | 数据类型 |            约束             |
| :------: | :----: | :------: | :-------------------------: |
|    ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
|  用户ID  |  uid   |   int    |         FOREIGN KEY         |
|  团体ID  |  gid   |   int    |         FOREIGN KEY         |
| 成员类型 |  type  | smallint |          NOT NULL           |

 `(uid, gid)` 组合添加了唯一约束。

```python
class UserInGroup(models.Model):
    """ 用户从属团体联系表 """
    TYPE = (
        (0, "创建人"),
        (1, "管理员"),
        (2, "成员"),
    )
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    type = models.SmallIntegerField(choices=TYPE)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'gid'], name='unique_user_in_group'),
        ]
```



**团体申请表：** 记录团体的申请信息与审批情况。

|  属性名  |   字段名   |   数据类型   |            约束             |
| :------: | :--------: | :----------: | :-------------------------: |
|    ID    |     id     |    bigint    | PRIMARY KEY、AUTO_INCREMENT |
|  用户ID  |    uid     |     int      |         FOREIGN KEY         |
|  团体ID  |    gid     |     int      |         FOREIGN KEY         |
| 申请内容 |  content   | varchar(128) |          NOT NULL           |
| 申请时间 | apply_time | datetime(6)  |          NOT NULL           |
| 申请状态 |   status   |   smallint   |          NOT NULL           |

`(uid, gid, apply_time)` 组合添加了唯一约束。

```python
class UserApplyGroup(models.Model):
    """ 用户申请团体联系表 """
    STATUS = (
        (0, "申请中"),
        (1, "已接受"),
        (2, "已拒绝"),
    )
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    content = models.CharField(max_length=128)
    apply_time = models.DateTimeField(auto_now_add=True, db_index=True)
    status = models.SmallIntegerField(choices=STATUS)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'gid', 'apply_time'], name='unique_user_apply_group'),
        ]
```



**场地使用情况表：** 记录活动和场地的联系与相关信息。

|  属性名  |   字段名   |  数据类型   |            约束             |
| :------: | :--------: | :---------: | :-------------------------: |
|    ID    |     id     |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|  活动ID  |    aid     |     int     |         FOREIGN KEY         |
|  场地ID  |    fid     |     int     |         FOREIGN KEY         |
| 起始时间 | start_time | datetime(6) |          NOT NULL           |
| 结束时间 |  end_time  | datetime(6) |          NOT NULL           |

`aid`、`(fid, start_time)` 组合和 `(fid, end_time) `组合添加了唯一约束。

```python
class ActivityUseField(models.Model):
    """ 活动使用场地联系表"""
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE)
    fid = models.ForeignKey(Field, on_delete=models.CASCADE)
    start_time = models.DateTimeField(db_index=True)
    end_time = models.DateTimeField(db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_activity_user_field1'),
            models.UniqueConstraint(fields=['fid', 'start_time'], name='unique_activity_user_field2'),
            models.UniqueConstraint(fields=['fid', 'end_time'], name='unique_activity_user_field3')
        ]
```



**用户参加活动记录表：** 记录活动的参与成员。

| 属性名 | 字段名 |  数据类型  |            约束             |
| :----: | :----: | :--------: | :-------------------------: |
|   ID   |   id   |   bigint   | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |    int     |         FOREIGN KEY         |
| 活动ID |  aid   |    int     |         FOREIGN KEY         |
|  喜欢  |  like  | tinyint(1) |          NOT NULL           |

`(uid, aid)` 组合添加了唯一约束。

```python
class UserInActivity(models.Model):
    """ 用户参加项目联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE, db_index=True)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)
    like = models.BooleanField()

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'aid'], name='unique_user_in_activity')
        ]
```



**用户创建活动记录表：** 记录个人活动的创建信息。

| 属性名 | 字段名 | 数据类型 |            约束             |
| :----: | :----: | :------: | :-------------------------: |
|   ID   |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |   int    |         FOREIGN KEY         |
| 活动ID |  aid   |   int    |         FOREIGN KEY         |

`aid`字段添加了唯一约束。

```python
class UserCreateActivity(models.Model):
    """ 用户发起活动联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_user_create_activity')
        ]
```



**团体创建活动记录表：** 记录团体活动的创建信息。

|  属性名  | 字段名 | 数据类型 |            约束             |
| :------: | :----: | :------: | :-------------------------: |
|    ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
|  团体ID  |  gid   |   int    |         FOREIGN KEY         |
| 创建人ID |  uid   |   int    |         FOREIGN KEY         |
|  活动ID  |  aid   |   int    |         FOREIGN KEY         |

`aid`字段添加了唯一约束。

```python
class GroupCreateActivity(models.Model):
    """ 团体发起活动联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_group_create_activity')
        ]
```



**用户器材借用表：** 记录个人借用器材的相关信息。

|    属性名    |   字段名    |  数据类型   |            约束             |
| :----------: | :---------: | :---------: | :-------------------------: |
|      ID      |     id      |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|    器材ID    |     eid     |     int     |         FOREIGN KEY         |
|    用户ID    |     uid     |     int     |         FOREIGN KEY         |
| 借用开始时间 | start_time  | datetime(6) |          NOT NULL           |
| 借用结束时间 |  end_time   | datetime(6) |          NOT NULL           |
|   是否归还   |  is_return  |  smallint   |          NOT NULL           |
|   借用数量   | lend_amount |     int     |          NOT NULL           |

`(eid, uid, start_time, end_time)`组合添加了唯一约束。

```python
class UserEquipment(models.Model):
    """ 用户借用器材联系表 """
    RETURN_STATUS = (
        (0, "未归还"),
        (2, "已归还"),
    )
    eid = models.ForeignKey(Equipment, on_delete=models.CASCADE)
    uid = models.ForeignKey(User, on_delete=models.CASCADE, db_index=True)
    start_time = models.DateTimeField()
    end_time = models.DateTimeField()
    lend_amount = models.IntegerField()
    is_return = models.SmallIntegerField(choices=RETURN_STATUS, default=0)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['eid', 'uid', 'start_time', 'end_time'], name='unique_user_equipment')
        ]
```



**团体器材借用表：** 记录团体借用器材的相关信息。

|    属性名    |   字段名    |  数据类型   |            约束             |
| :----------: | :---------: | :---------: | :-------------------------: |
|      ID      |     id      |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|    器材ID    |     eid     |     int     |         FOREIGN KEY         |
|    团体ID    |     gid     |     int     |         FOREIGN KEY         |
| 借用开始时间 | start_time  | datetime(6) |          NOT NULL           |
| 借用结束时间 |  end_time   | datetime(6) |          NOT NULL           |
|   是否归还   |  is_return  |  smallint   |          NOT NULL           |
|   借用数量   | lend_amount |     int     |          NOT NULL           |

`(eid, gid, start_time, end_time)`组合添加了唯一约束。

```python
class GroupEquipment(models.Model):
    """ 团体借用器材联系表 """
    RETURN_STATUS = (
        (0, "未归还"),
        (2, "已归还"),
    )
    eid = models.ForeignKey(Equipment, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    start_time = models.DateTimeField()
    end_time = models.DateTimeField()
    lend_amount = models.IntegerField()
    is_return = models.SmallIntegerField(choices=RETURN_STATUS, default=0)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['eid', 'gid', 'start_time', 'end_time'], name='unique_group_equipment')
        ]
```



**好友联系表：** 记录用户-用户好友联系。

| 属性名  | 字段名 | 数据类型 |            约束             |
| :-----: | :----: | :------: | :-------------------------: |
|   ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID1 |  uid1  |   int    |         FOREIGN KEY         |
| 用户ID2 |  uid2  |   int    |         FOREIGN KEY         |

`(uid1, uid2)`组合添加了唯一约束。

```python
class Friend(models.Model):
    """ 好友联系表 """
    uid1 = models.ForeignKey(User, on_delete=models.CASCADE, related_name='friends1')
    uid2 = models.ForeignKey(User, on_delete=models.CASCADE, related_name='friends2')

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid1', 'uid2'], name='unique_friend')
        ]
```



**好友申请表：** 记录好友申请信息和审批状态。

|  属性名  |   字段名   |   数据类型   |            约束             |
| :------: | :--------: | :----------: | :-------------------------: |
|    ID    |     id     |    bigint    | PRIMARY KEY、AUTO_INCREMENT |
| 申请者ID |   sender   |     int      |         FOREIGN KEY         |
| 接收者ID |  receiver  |     int      |         FOREIGN KEY         |
| 申请内容 |  content   | varchar(128) |          NOT NULL           |
| 申请时间 | apply_time | datetime(6)  |          NOT NULL           |
| 申请状态 |   status   |   smallint   |          NOT NULL           |

`(sender, receiver, apply_time)`组合添加了唯一约束。

```python
class FriendApply(models.Model):
    """ 好友申请表 """
    STATUS = (
        (0, "申请中"),
        (1, "已接受"),
        (2, "已拒绝"),
    )
    sender = models.ForeignKey(User, on_delete=models.CASCADE, related_name='sender')
    receiver = models.ForeignKey(User, on_delete=models.CASCADE, related_name='receiver')
    content = models.CharField(max_length=128)
    apply_time = models.DateTimeField(auto_now_add=True, db_index=True)
    status = models.SmallIntegerField(choices=STATUS)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['sender', 'receiver', 'apply_time'], name='unique_friend_apply')
        ]
```



**动态点赞记录表：** 记录用户点赞动态的先关信息。

| 属性名 | 字段名 | 数据类型 |            约束             |
| :----: | :----: | :------: | :-------------------------: |
|   ID   |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |   int    |         FOREIGN KEY         |
| 动态ID |  sid   |   int    |         FOREIGN KEY         |

 `(uid, sid)` 组合添加了唯一约束。

```python
class UserFavorStream(models.Model):
    """ 用户点赞动态记录表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    sid = models.ForeignKey(Stream, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'sid'], name='unique_user_favor_stream')
        ]
```



## 三、系统重要功能实现方法





## 四、系统实现结果



## 五、总结