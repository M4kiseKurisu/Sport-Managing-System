# 系统实现报告



## 一、系统结构设计

### 1.1 体系结构

此系统应用采用了前端、后端、数据库分离的体系结构。数据库层次负责存储、管理数据；后端层次根据前端请求，与数据库做交互，对数据库的数据进行增删改查，并进行处理，按需传给前端；前端层次根据后端传入的数据，展示渲染页面，并与用户交互，依据用户的操作向后端发送请求。

#### 1.1.1 系统实现环境

**前端**：



**后端**：采用 Django 框架，使用 Python 开发语言。

依赖包：

```
Django              4.2.6
django-cors-headers 4.3.0
mysqlclient         2.2.0
Pillow              10.1.0
PyMySQL             1.1.0
```

**数据库**：使用华为 GaussDB 云数据库，支持 MySQL 语法。

#### 1.1.2 前端结构



#### 1.1.3 后端结构

后端的文件结构如下：

```
├─api                 存放和数据库有关的代码
│  ├─ migrations      存放数据库迁移文件
│  ├─ system          存放系统配置函数，包括上传图片的重命名方法
│  └─ views           存放处理请求并返回响应的视图代码
│     ├─ entity       存放数据库实体表有关的代码
│     ├─ relation     存放数据库联系表有关的代码
│     └─ util         工具包
├─backend             Django 配置
└─media               保存上传的文件
    └─images          存放前端上传的图片
```



### 1.2 功能结构

<img src=".\images\功能结构图.png" style="zoom:75%;" />



<br>

## 二、数据库基本表的定义

在后端数据库实现中，我们选择采用 Django 中的 ORM 技术，在 `models.py` 文件中定义了 7 个实体表和 11 个联系表，这些表的结构和关系都通过类继承 `models.Model` 来定义，并且利用 ORM 提供的语法来定义了数据库表的类型、约束和关系。通过 ORM，能够以面向对象的方式来操作数据库，简化了数据库操作的编程过程，并提高了开发效率。

### 2.1 实体表

**用户表：**管理用户个人信息。

|  属性名  |     字段名     |   数据类型   |       约束       |
| :------: | :------------: | :----------: | :--------------: |
|    ID    |      uid       |     int      |   PRIMARY KEY    |
|   账号   |    account     | varchar(32)  | NOT NULL、UNIQUE |
|   密码   |    password    | varchar(32)  |     NOT NULL     |
|   姓名   |   user_name    | varchar(10)  |     NOT NULL     |
|   性别   |  user_gender   |   smallint   |     NOT NULL     |
|   年龄   |    user_age    |     int      |     NOT NULL     |
| 个人签名 | user_signature | varchar(128) |     NOT NULL     |
| 电话号码 |  phone_number  |    bigint    | NOT NULL、UNIQUE |
|   邮箱   |     email      | varchar(32)  | NOT NULL、UNIQUE |
|   头像   |    picture     | varchar(100) |                  |

```python
class User(models.Model):
    """ 用户实体表 """
    USER_GENDER = (
        (0, '女'),
        (1, '男'),
    )
    uid = models.IntegerField(primary_key=True)
    account = models.CharField(max_length=32, unique=True)
    password = models.CharField(max_length=32)
    user_name = models.CharField(max_length=10)
    user_age = models.IntegerField()
    user_gender = models.SmallIntegerField(choices=USER_GENDER)
    phone_number = models.BigIntegerField(unique=True)
    email = models.EmailField(max_length=32, unique=True)
    user_signature = models.CharField(max_length=128, default="", blank=True)
    picture = models.ImageField(upload_to='images/user/', storage=ImageStorage(), null=True)
```



**团体表：**管理团体的基本信息。

|  属性名  |   字段名   |   数据类型   |       约束       |
| :------: | :--------: | :----------: | :--------------: |
|    ID    |    gid     |     int      |   PRIMARY KEY    |
|   名称   | group_name | varchar(32)  | NOT NULL、UNIQUE |
|   描述   | group_desc | varchar(128) |     NOT NULL     |
| 团体图片 |  picture   | varchar(100) |                  |
| 人数限制 |  maximum   |     int      |     NOT NULL     |
| 成员人数 |  capacity  |     int      |     NOT NULL     |
|   标签   |    tag     | varchar(32)  |     NOT NULL     |
|  创建人  |  creator   |     int      |   FOREIGN KEY    |

```python
class Group(models.Model):
    """ 团体实体表 """
    gid = models.IntegerField(primary_key=True)
    creator = models.ForeignKey(User, on_delete=models.CASCADE)
    group_name = models.CharField(max_length=32, unique=True)
    group_desc = models.CharField(max_length=128)
    tag = models.CharField(max_length=32)
    maximum = models.IntegerField()
    capacity = models.IntegerField()
    picture = models.ImageField(upload_to='images/group/', storage=ImageStorage(), null=True)
```



**器材表：**管理器材实体的基本信息。

|  属性名  |  字段名  |   数据类型   |       约束       |
| :------: | :------: | :----------: | :--------------: |
|    ID    |   eid    |     int      |   PRIMARY KEY    |
|   类别   | category | varchar(32)  | NOT NULL、UNIQUE |
|   数量   |  amount  |     int      |     NOT NULL     |
| 器材图片 | picture  | varchar(100) |                  |

```python
class Equipment(models.Model):
    """ 器材实体表 """
    eid = models.IntegerField(primary_key=True)
    category = models.CharField(max_length=32, unique=True)
    amount = models.IntegerField(default=0)
    picture = models.ImageField(upload_to='images/equipment/', storage=ImageStorage(), null=True)
```



**场地表：**管理场地的基本信息。

|  属性名  |   字段名   |  数据类型   |       约束       |
| :------: | :--------: | :---------: | :--------------: |
|    ID    |    fid     |     int     |   PRIMARY KEY    |
|   位置   |  location  | varchar(32) | NOT NULL、UNIQUE |
|   类别   |  category  | varchar(16) |     NOT NULL     |
| 开始时间 | open_time  |   time(6)   |     NOT NULL     |
| 结束时间 | close_time |   time(6)   |     NOT NULL     |
| 项目限制 |   limit    | tinyint(1)  |     NOT NULL     |

```python
class Field(models.Model):
    """ 运动场地实体表 """
    fid = models.IntegerField(primary_key=True)
    location = models.CharField(max_length=32, unique=True)
    category = models.CharField(max_length=16, db_index=True)
    limit = models.BooleanField()
    open_time = models.TimeField()
    close_time = models.TimeField()
```



**活动表：**管理活动基本信息。

|    属性名    |    字段名    |   数据类型   |    约束     |
| :----------: | :----------: | :----------: | :---------: |
|      ID      |     aid      |     int      | PRIMARY KEY |
|   活动名称   |     name     | varchar(32)  |  NOT NULL   |
|   活动描述   |     desc     | varchar(128) |  NOT NULL   |
|   活动图片   |   picture    | varchar(100) |             |
| 活动人数限制 |   maximum    |     int      |  NOT NULL   |
|   参与人数   |   capacity   |     int      |  NOT NULL   |
|   活动类型   |   category   | varchar(32)  |  NOT NULL   |
|     标签     |     tags     | varchar(128) |  NOT NULL   |
|  创建者类型  | creator_type |   smallint   |  NOT NULL   |
|    获赞数    |    favor     |     int      |  NOT NULL   |
|    私有性    |   private    |  tinyint(1)  |  NOT NULL   |

```python
class Activity(models.Model):
    """ 活动项目实体表 """
    TYPE = (
        (0, "个人"),
        (1, "团体"),
    )
    aid = models.IntegerField(primary_key=True)
    type = models.SmallIntegerField(choices=TYPE, db_index=True)
    name = models.CharField(max_length=32, db_index=True)
    desc = models.CharField(max_length=128)
    category = models.CharField(max_length=32, db_index=True)
    tags = models.CharField(max_length=128)
    maximum = models.IntegerField()
    capacity = models.IntegerField()
    favor = models.IntegerField()
    picture = models.ImageField(upload_to='images/activity/', storage=ImageStorage(), null=True)
    private = models.BooleanField()
```



**通知表：**管理系统通知的基本数据。

|  属性名  |  字段名  |   数据类型   |    约束     |
| :------: | :------: | :----------: | :---------: |
|    ID    |   nid    |     int      | PRIMARY KEY |
| 通知时间 |   time   | datetime(6)  |  NOT NULL   |
| 通知内容 |   text   | varchar(128) |  NOT NULL   |
| 通知对象 | receiver |     int      | FOREIGN KEY |

```python
class Notice(models.Model):
    """ 系统通知表 """
    nid = models.IntegerField(primary_key=True)
    time = models.DateTimeField(auto_now_add=True, db_index=True)
    text = models.CharField(max_length=128)
    receiver = models.ForeignKey(User, on_delete=models.CASCADE)
```



**动态表：**管理用户发表的动态信息。

|  属性名  |  字段名  |   数据类型   |    约束     |
| :------: | :------: | :----------: | :---------: |
|    ID    |   sid    |     int      | PRIMARY KEY |
| 发布时间 |   time   | datetime(6)  |  NOT NULL   |
| 发布文本 |   text   | varchar(512) |  NOT NULL   |
| 发布图片 | picture  | varchar(100) |             |
|  获赞数  |  favor   |     int      |  NOT NULL   |
|  私有性  | private  |   smallint   |  NOT NULL   |
| 所属用户 |   user   |     int      | FOREIGN KEY |
| 关联活动 | activity |     int      | FOREIGN KEY |

```python
class Stream(models.Model):
    """ 动态表 """
    PRIVACY = (
        (0, "仅自己可见"),
        (1, "好友可见"),
        (2, "所有人可见"),
    )
    sid = models.IntegerField(primary_key=True)
    time = models.DateTimeField(auto_now_add=True, db_index=True)
    text = models.CharField(max_length=512)
    picture = models.ImageField(upload_to='images/stream/', storage=ImageStorage(), null=True)
    favor = models.IntegerField(default=0)
    private = models.SmallIntegerField(choices=PRIVACY)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    activity = models.ForeignKey(Activity, on_delete=models.CASCADE)
```



### 2.2 联系表

由于 ORM 不支持多个字段共同作为主键，因此没有指定主键的表会自动添加一个自增的 id 字段。

**团体成员表：**记录团体的成员信息。

|  属性名  | 字段名 | 数据类型 |            约束             |
| :------: | :----: | :------: | :-------------------------: |
|    ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
|  用户ID  |  uid   |   int    |         FOREIGN KEY         |
|  团体ID  |  gid   |   int    |         FOREIGN KEY         |
| 成员类型 |  type  | smallint |          NOT NULL           |

 `(uid, gid)` 组合添加了唯一约束。

```python
class UserInGroup(models.Model):
    """ 用户从属团体联系表 """
    TYPE = (
        (0, "创建人"),
        (1, "管理员"),
        (2, "成员"),
    )
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    type = models.SmallIntegerField(choices=TYPE)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'gid'], name='unique_user_in_group'),
        ]
```



**团体申请表：**记录团体的申请信息与审批情况。

|  属性名  |   字段名   |   数据类型   |            约束             |
| :------: | :--------: | :----------: | :-------------------------: |
|    ID    |     id     |    bigint    | PRIMARY KEY、AUTO_INCREMENT |
|  用户ID  |    uid     |     int      |         FOREIGN KEY         |
|  团体ID  |    gid     |     int      |         FOREIGN KEY         |
| 申请内容 |  content   | varchar(128) |          NOT NULL           |
| 申请时间 | apply_time | datetime(6)  |          NOT NULL           |
| 申请状态 |   status   |   smallint   |          NOT NULL           |

`(uid, gid, apply_time)` 组合添加了唯一约束。

```python
class UserApplyGroup(models.Model):
    """ 用户申请团体联系表 """
    STATUS = (
        (0, "申请中"),
        (1, "已接受"),
        (2, "已拒绝"),
    )
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    content = models.CharField(max_length=128)
    apply_time = models.DateTimeField(auto_now_add=True, db_index=True)
    status = models.SmallIntegerField(choices=STATUS)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'gid', 'apply_time'], name='unique_user_apply_group'),
        ]
```



**场地使用情况表：**记录活动和场地的联系与相关信息。

|  属性名  |   字段名   |  数据类型   |            约束             |
| :------: | :--------: | :---------: | :-------------------------: |
|    ID    |     id     |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|  活动ID  |    aid     |     int     |         FOREIGN KEY         |
|  场地ID  |    fid     |     int     |         FOREIGN KEY         |
| 起始时间 | start_time | datetime(6) |          NOT NULL           |
| 结束时间 |  end_time  | datetime(6) |          NOT NULL           |

`aid`、`(fid, start_time)` 组合和 `(fid, end_time) `组合添加了唯一约束。

```python
class ActivityUseField(models.Model):
    """ 活动使用场地联系表"""
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE)
    fid = models.ForeignKey(Field, on_delete=models.CASCADE)
    start_time = models.DateTimeField(db_index=True)
    end_time = models.DateTimeField(db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_activity_user_field1'),
            models.UniqueConstraint(fields=['fid', 'start_time'], name='unique_activity_user_field2'),
            models.UniqueConstraint(fields=['fid', 'end_time'], name='unique_activity_user_field3')
        ]
```



**用户参加活动记录表：**记录活动的参与成员。

| 属性名 | 字段名 |  数据类型  |            约束             |
| :----: | :----: | :--------: | :-------------------------: |
|   ID   |   id   |   bigint   | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |    int     |         FOREIGN KEY         |
| 活动ID |  aid   |    int     |         FOREIGN KEY         |
|  喜欢  |  like  | tinyint(1) |          NOT NULL           |

`(uid, aid)` 组合添加了唯一约束。

```python
class UserInActivity(models.Model):
    """ 用户参加项目联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE, db_index=True)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)
    like = models.BooleanField()

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'aid'], name='unique_user_in_activity')
        ]
```



**用户创建活动记录表：**记录个人活动的创建信息。

| 属性名 | 字段名 | 数据类型 |            约束             |
| :----: | :----: | :------: | :-------------------------: |
|   ID   |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |   int    |         FOREIGN KEY         |
| 活动ID |  aid   |   int    |         FOREIGN KEY         |

`aid`字段添加了唯一约束。

```python
class UserCreateActivity(models.Model):
    """ 用户发起活动联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_user_create_activity')
        ]
```



**团体创建活动记录表：**记录团体活动的创建信息。

|  属性名  | 字段名 | 数据类型 |            约束             |
| :------: | :----: | :------: | :-------------------------: |
|    ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
|  团体ID  |  gid   |   int    |         FOREIGN KEY         |
| 创建人ID |  uid   |   int    |         FOREIGN KEY         |
|  活动ID  |  aid   |   int    |         FOREIGN KEY         |

`aid`字段添加了唯一约束。

```python
class GroupCreateActivity(models.Model):
    """ 团体发起活动联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_group_create_activity')
        ]
```



**用户器材借用表：**记录个人借用器材的相关信息。

|    属性名    |   字段名    |  数据类型   |            约束             |
| :----------: | :---------: | :---------: | :-------------------------: |
|      ID      |     id      |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|    器材ID    |     eid     |     int     |         FOREIGN KEY         |
|    用户ID    |     uid     |     int     |         FOREIGN KEY         |
| 借用开始时间 | start_time  | datetime(6) |          NOT NULL           |
| 借用结束时间 |  end_time   | datetime(6) |          NOT NULL           |
|   是否归还   |  is_return  |  smallint   |          NOT NULL           |
|   借用数量   | lend_amount |     int     |          NOT NULL           |

`(eid, uid, start_time, end_time)`组合添加了唯一约束。

```python
class UserEquipment(models.Model):
    """ 用户借用器材联系表 """
    RETURN_STATUS = (
        (0, "未归还"),
        (2, "已归还"),
    )
    eid = models.ForeignKey(Equipment, on_delete=models.CASCADE)
    uid = models.ForeignKey(User, on_delete=models.CASCADE, db_index=True)
    start_time = models.DateTimeField()
    end_time = models.DateTimeField()
    lend_amount = models.IntegerField()
    is_return = models.SmallIntegerField(choices=RETURN_STATUS, default=0)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['eid', 'uid', 'start_time', 'end_time'], name='unique_user_equipment')
        ]
```



**团体器材借用表：**记录团体借用器材的相关信息。

|    属性名    |   字段名    |  数据类型   |            约束             |
| :----------: | :---------: | :---------: | :-------------------------: |
|      ID      |     id      |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|    器材ID    |     eid     |     int     |         FOREIGN KEY         |
|    团体ID    |     gid     |     int     |         FOREIGN KEY         |
| 借用开始时间 | start_time  | datetime(6) |          NOT NULL           |
| 借用结束时间 |  end_time   | datetime(6) |          NOT NULL           |
|   是否归还   |  is_return  |  smallint   |          NOT NULL           |
|   借用数量   | lend_amount |     int     |          NOT NULL           |

`(eid, gid, start_time, end_time)`组合添加了唯一约束。

```python
class GroupEquipment(models.Model):
    """ 团体借用器材联系表 """
    RETURN_STATUS = (
        (0, "未归还"),
        (2, "已归还"),
    )
    eid = models.ForeignKey(Equipment, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    start_time = models.DateTimeField()
    end_time = models.DateTimeField()
    lend_amount = models.IntegerField()
    is_return = models.SmallIntegerField(choices=RETURN_STATUS, default=0)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['eid', 'gid', 'start_time', 'end_time'], name='unique_group_equipment')
        ]
```



**好友联系表：**记录用户-用户好友联系。

| 属性名  | 字段名 | 数据类型 |            约束             |
| :-----: | :----: | :------: | :-------------------------: |
|   ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID1 |  uid1  |   int    |         FOREIGN KEY         |
| 用户ID2 |  uid2  |   int    |         FOREIGN KEY         |

`(uid1, uid2)`组合添加了唯一约束。

```python
class Friend(models.Model):
    """ 好友联系表 """
    uid1 = models.ForeignKey(User, on_delete=models.CASCADE, related_name='friends1')
    uid2 = models.ForeignKey(User, on_delete=models.CASCADE, related_name='friends2')

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid1', 'uid2'], name='unique_friend')
        ]
```



**好友申请表：**记录好友申请信息和审批状态。

|  属性名  |   字段名   |   数据类型   |            约束             |
| :------: | :--------: | :----------: | :-------------------------: |
|    ID    |     id     |    bigint    | PRIMARY KEY、AUTO_INCREMENT |
| 申请者ID |   sender   |     int      |         FOREIGN KEY         |
| 接收者ID |  receiver  |     int      |         FOREIGN KEY         |
| 申请内容 |  content   | varchar(128) |          NOT NULL           |
| 申请时间 | apply_time | datetime(6)  |          NOT NULL           |
| 申请状态 |   status   |   smallint   |          NOT NULL           |

`(sender, receiver, apply_time)`组合添加了唯一约束。

```python
class FriendApply(models.Model):
    """ 好友申请表 """
    STATUS = (
        (0, "申请中"),
        (1, "已接受"),
        (2, "已拒绝"),
    )
    sender = models.ForeignKey(User, on_delete=models.CASCADE, related_name='sender')
    receiver = models.ForeignKey(User, on_delete=models.CASCADE, related_name='receiver')
    content = models.CharField(max_length=128)
    apply_time = models.DateTimeField(auto_now_add=True, db_index=True)
    status = models.SmallIntegerField(choices=STATUS)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['sender', 'receiver', 'apply_time'], name='unique_friend_apply')
        ]
```



**动态点赞记录表：**记录用户点赞动态的先关信息。

| 属性名 | 字段名 | 数据类型 |            约束             |
| :----: | :----: | :------: | :-------------------------: |
|   ID   |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |   int    |         FOREIGN KEY         |
| 动态ID |  sid   |   int    |         FOREIGN KEY         |

 `(uid, sid)` 组合添加了唯一约束。

```python
class UserFavorStream(models.Model):
    """ 用户点赞动态记录表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    sid = models.ForeignKey(Stream, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'sid'], name='unique_user_favor_stream')
        ]
```



## 三、系统重要功能实现方法

### 3.1 触发器

合理使用数据库触发器可以防⽌产生异常数据。本项目中主要对删除操作设置触发器，保证数据的完整性和一致性。



### 3.2 存储过程

数据库数据的增删改仅涉及到 `POST` 接口，故本部分主要列出 `POST` 接口对应的数据库存储过程的逻辑，同时也包括一些重要的 `GET` 接口的实现逻辑。

#### 3.2.1 用户管理

**注册**：

这一过程获取前端传来的数据，在 `User` 表中检查电话号码、邮箱、账号的唯一约束。如果错误则返回错误信息，否则随机生成唯一的 ID 填入 `User` 表中。

```python
@require_http_methods(["POST"])
def register(request):
    """ 用户注册 """
    data: dict = json.loads(request.body)
    account = data.get('account')
    phone_number = data.get("phone_number")
    email = data.get("email")
    if User.objects.filter(account=account).first():
        return JsonResponse({"msg": "账号已被注册", "status": False, "uid": "", "user_name": ""})
    elif User.objects.filter(Q(phone_number=phone_number) | Q(email=email)).first():
        return JsonResponse({"msg": "电话或邮箱已被注册", "status": False, "uid": "", "user_name": ""})
    else:
        uid = genid()
        password = data.get('password')
        user_name = data.get('user_name')
        user_age = data.get("user_age")
        user_gender = data.get("user_gender")
        user_signature = ""
        new_user = User(uid=uid, account=account, password=password, user_name=user_name,
                        user_age=user_age, user_gender=user_gender, phone_number=phone_number,
                        email=email, user_signature=user_signature)
        new_user.save()
        return JsonResponse({"msg": "注册成功", "status": True, "uid": uid, "user_name": user_name})
```

**登录**：

这一过程根据用户输入的账号密码，查找`User`表是否有匹配的数据项，并将基本的用户信息返回给前端。

```python
@require_http_methods(["GET"])
def login(request):
    """ 用户登录验证 """
    account = request.GET.get('account')
    password = request.GET.get('password')
    user = User.objects.filter(account=account, password=password).first()
    if user:
        return JsonResponse({"msg": '登录成功', "status": True, "uid": user.uid, "user_name": user.user_name,
                             "picture": user.picture.url if user.picture else None})
    else:
        return JsonResponse({"msg": '登录失败', "status": False, "uid": None, "user_name": None})
```

**修改个人信息**：

这一过程用于修改用户个人的信息，由于用户输入的数据并不确定，为了保证数据库约束完整，需要对用户修改的电话号码、邮箱信息进行检查，如果已存在则返回错误，否则将新的数据写入`User`表对应表项中。

```python
@require_http_methods(["POST"])
def modify_text(request):
    """ 修改个人信息 """
    req: dict = json.loads(request.body)
    print(req)
    user = User.objects.get(uid=req.get('uid'))
    # 数据库约束检查
    phone_number = req.get('data').get('phone_number')
    email = req.get('data').get('email')
    if phone_number and phone_number != user.phone_number:
        if User.objects.filter(phone_number=phone_number).first():
            return JsonResponse({"msg": "电话号码已存在", "status": False})
    if email and email != user.email:
        if User.objects.filter(email=email).first():
            return JsonResponse({"msg": "邮箱已存在", "status": False})

    for (key, value) in req.get('data').items():
        print(key, value)
        setattr(user, key, value)
    user.save()
    return JsonResponse({"msg": "个人信息修改成功", "status": True})
```

**上传用户头像**：

利用 Django 框架上传用户头像，将图片路径存入到 `User` 表的 `picture` 字段里。

```python
@require_http_methods(["POST"])
def modify_pic(request):
    """ 修改个人头像 """
    print(request.POST)
    user = User.objects.get(uid=request.POST.get('uid'))
    user.picture = request.FILES['picture']
    user.save()
    return JsonResponse({"msg": "头像已更新", "status": True})
```

**获取用户参加的团体**：

`UserInGroup` 表和 `Group `表依据团体 ID 进行自然连接，以用户 ID 查找相关数据项，并把团体的基本信息以数组形式返回给前端进行展示。

```python
@require_http_methods(["GET"])
def group_list(request):
    """ 查看用户所属团体 """
    uid = request.GET.get('uid')
    lst = list(map(lambda param: {'gid': param.gid.gid, 'group_name': param.gid.group_name,
                                  'group_desc': param.gid.group_desc, 'tag': param.gid.tag,
                                  'capacity': param.gid.capacity, 'maximum': param.gid.maximum,
                                  'creator': param.gid.creator.user_name,
                                  'pic': param.gid.picture.url if param.gid.picture else None,
                                  "type": param.get_type_display()},
                   user_group.search_relation(uid, None)))
    print(lst)
    return JsonResponse({"msg": '团体信息请求成功', "status": True, "list": lst})
```

**获取用户参加的活动**：

`UserInActivity` 表、 `Activity` 表和`ActivityUseField`表按照活动 ID 进行自然连接，以用户 ID 查找相关数据项。将查询结果的活动基本信息以数组形式返回给前端进行展示。

```python
@require_http_methods(["GET"])
def activity_list(request):
    """ 查看用户参加的活动 """
    uid = request.GET.get('uid')
    user = User.objects.get(uid=uid)
    activities = set()
    liked_activities = set()
    for rec in UserInActivity.objects.filter(uid=user):
        if rec.like:
            liked_activities.add(rec.aid)
        activities.add(rec.aid)
    lst = list(map(lambda param: {"aid": param.aid.aid, "name": param.aid.name, 
                                  "type": param.aid.get_type_display(),
                                  "private": param.aid.private, "category": param.aid.category,
                                  "capacity": param.aid.capacity, "maximum": param.aid.maximum,
                                  "picture": param.aid.picture.url if param.aid.picture else None,
                                  "start_time": param.start_time.strftime("%Y-%m-%d %H:%M:%S"),
                                  "end_time": param.end_time.strftime("%Y-%m-%d %H:%M:%S"),
                                  "favor": param.aid.favor, "is_favor": param.aid in liked_activities},
                   ActivityUseField.objects.filter(aid__in=activities).order_by('-start_time')))
    print(lst)
    return JsonResponse({"msg": '活动信息获取成功', "status": True, "list": lst})
```



#### 3.2.2 团体模块

**创建团体**：

这一过程检查`Group`表中团体名的唯一性约束是否满足，如果失败则返回错误信息，成功则插入新的团体信息，并且将团体创建者 ID 和 团体 ID 的联系填入 `UserInGroup` 表中。

```python
def create(request):
    """ 用户创建团体 """
    if request.method == 'POST':
        data = request.POST
        print(data)
        uid = data.get("uid")
        group_name = data.get("group_name")
        group_desc = data.get("group_desc")
        maximum = data.get("maximum")
        tag = data.get("tag")

        if Group.objects.filter(group_name=group_name):
            return JsonResponse({"msg": "团体名称已被使用", "status": False})
        else:
            # 添加团体信息
            gid = genid()
            creator = User.objects.get(uid=uid)
            new_group = Group(gid=gid, creator=creator, group_name=group_name, group_desc=group_desc,
                              tag=tag, maximum=maximum, capacity=0, picture=request.FILES['picture'])
            new_group.save()
            # 添加用户团体联系
            user_group.add_relation(uid, gid, 0)
            return JsonResponse({"msg": "团体创建成功", "status": True, "group_name": group_name, "gid": gid})
    else:
        return JsonResponse({"msg": "请求方式有误", "status": False})
```

**查看团体**：

这一过程允许用户通过关键字搜索，因此在 `Group` 表中按照类似于 ` MySQL` 中的 `in` 运算符进行模糊搜索，将获取的团体基本信息以列表的形式返回给前端。

```python
@require_http_methods(["GET"])
def view(request):
    """ 用户查看团体中心综述 """
    key = request.GET.get('keyword') or ''
    uid = request.GET.get('uid')
    groups = Group.objects.filter(
        Q(group_name__icontains=key) | Q(group_desc__icontains=key) | Q(tag__icontains=key)
    )
    joined_groups = list(map(lambda param: param.gid.gid, user_group.search_relation(uid, None)))

    lst = list(map(lambda param: {"gid": param.gid, "group_name": param.group_name, 
                                  "group_desc": param.group_desc,
                                  "tag": param.tag, "capacity": param.capacity, "maximum": param.maximum,
                                  "creator": param.creator.user_name, "is_joined": param.gid in joined_groups,
                                  "pic": param.picture.url if param.picture else None},
                   groups))

    return JsonResponse({"msg": "团体信息请求成功", "status": True, "list": lst})
```

**申请加入团体**：

这一过程首先需要到数据库中检查申请的有效性：一是到`Group`表中找到对应团体，比较成员人数和最大人数限制，如果人数已达上限，则申请失败。第二是查找`UserApplyGroup`表，查找是否存在用户向该团体的审核处于正在进行的状态，有则申请失败。

如果申请成功则向`UserApplyGroup`表中

```python
@require_http_methods(["POST"])
def join(request):
    """ 用户申请加入团体 """
    data: dict = json.loads(request.body)
    print(data)
    uid = data.get("uid")
    gid = data.get("gid")
    content = data.get("content")
    msg, status = user_group.add_apply(uid, gid, content)
    return JsonResponse({"msg": msg, "status": status})
    
def add_apply(uid, gid, content):
    """ 增加用户申请团体信息 """
    user = User.objects.get(uid=uid)
    group = Group.objects.get(gid=gid)

    if group.maximum == group.capacity:
        return "团体人数已达上限", False
    if UserApplyGroup.objects.filter(uid=user, gid=group, status=0).first():
        return "已有申请正在审核中，请耐心等待", False
    else:
        apply = UserApplyGroup(uid=user, gid=group, content=content, status=0)
        apply.save()
        for rec in UserInGroup.objects.filter(Q(gid=group) & Q(Q(type=0) | Q(type=1))):
            notice.add_notice_to_user(rec.uid, user.user_name + "申请加入团体" + group.group_name)
        return "申请信息已发送", True
```

**查看团队申请**：

查看团队申请包括用户发送的请求和自己管理团体收到的请求。对于前者，以用户 ID 到 `UserApplyGroup` 表查找相应的数据项；对于后者，将 `UserInGroup` 表和 `UserApplyGroup` 表依据团队 ID 作自然连接，以依据用户ID，查找成员类型是创建者或管理员的团队的申请记录，并根据申请时间逆序排序。

```python
@require_http_methods(["GET", "POST"])
def apply(request):
    if request.method == 'GET':
        """ 查看团体申请信息 """
        uid = request.GET.get('uid')
        method = request.GET.get('method')
        lst = []

        if method == "accept":
            applies = user_group.search_accept_apply(uid)
            for a in applies:
                temp = {"uid": a.uid.uid, "user_name": a.uid.user_name, "content": a.content,
                        "gid": a.gid.gid, "group_name": a.gid.group_name,
                        "time": a.apply_time.strftime("%Y-%m-%d %H:%M:%S"),
                        "status": a.get_status_display()}
                lst.append(temp)

        elif method == "send":
            applies = user_group.search_send_apply(uid)
            for a in applies:
                temp = {"gid": a.gid.gid, "group_name": a.gid.group_name, "content": a.content,
                        "time": a.apply_time.strftime("%Y-%m-%d %H:%M:%S"),
                        "status": a.get_status_display()}
                lst.append(temp)
        else:
            return JsonResponse({"msg": "method参数错误", "status": False})
```

**审批团体申请**：

这一过程根据申请时间、团队ID、申请人ID 到`UserApplyGroup` 表中查到指定记录，并将审核结果填入表中，把审核情况填入到通知表 `Notice` 中。对于团体人数已达上限的申请，同意会返回错误。最终被同意的申请，会将用户-团体联系添加到 `UserInGroup` 表中，并维护 `Group` 表的人数属性。

```py
@require_http_methods(["GET", "POST"])
def apply(request):
    if request.method == 'POST':
        """ 处理团体申请 """
        data: dict = json.loads(request.body)
        print(data)
        if user_group.modify_apply(data.get('uid'), data.get('gid'), data.get('res')):
            return JsonResponse({"msg": "处理完成", "status": True})
        else:
            return JsonResponse({"msg": "团体人数已达上限", "status": False})
```

**退出团体**：

这一过程依据用户 ID 和团体 ID 在`UserInGroup` 表中查找记录，同时判断用户成员类型，如果是管理员或成员，则删除联系，将团体的人数属性减一；如果是创建人，则会解散团体，将团体从`Group`表中删除，由于 Django 表设计时所有外键都设置了级联删除，因此会将有关的联系一并删去，保证了数据的一致性。

```python
@require_http_methods(["POST"])
def exit_out(request):
    """ 用户退出团体 """
    data: dict = json.loads(request.body)
    print(data)
    uid = data.get('uid')
    gid = data.get('gid')
    user_group.delete_relation(uid, gid)
    return JsonResponse({"msg": "团体已退出", "status": True})
```

**移除成员**：

这一部分依据用户ID、团体ID到`UserInGroup`表查找数据删除，更新到系统通知表中，并更新团体的人数属性。

```py
@require_http_methods(["POST"])
def members_remove(request):
    """ 移除团体成员 """
    data: dict = json.loads(request.body)
    uid = data.get('uid')
    gid = data.get('gid')
    group = Group.objects.get(gid=gid)
    user_group.delete_relation(uid, gid)
    notice.add_notice_to_uid(uid, "很抱歉，您已被移出团体 (" + group.group_name + ")")
    return JsonResponse({"msg": "成员已移除", "status": True})
```

**修改成员权限**：

修改成员权限包括管理员到普通成员，普通成员到管理员两种操作。依据用户ID、团体ID到`UserInGroup`表查找数据修改成员类型属性。

```python
@require_http_methods(["POST"])
def members_authority(request):
    data: dict = json.loads(request.body)
    uid = data.get('uid')
    gid = data.get('gid')
    member_type = data.get('type')
    if member_type == 0:
        return JsonResponse({"msg": "无法修改团体创建人信息", "status": False})
    elif member_type == 1:
        user_group.modify_relation(uid, gid, member_type)
        return JsonResponse({"msg": "添加团体管理员成功", "status": True})
    elif member_type == 2:
        user_group.modify_relation(uid, gid, member_type)
        return JsonResponse({"msg": "移除团体管理员成功", "status": True})
```

**查看团体活动**：

这一过程将`Group`与 `GroupCreateActivity` 按照团队ID进行自然连接，查找指定团体的活动创建信息，并将活动的基本数据返回。

```python
def activity_list(request):
    """ 查看团体创建过的活动 """
    gid = request.GET.get('gid')
    group = Group.objects.get(gid=gid)
    activities = set(map(lambda param: param.aid, GroupCreateActivity.objects.filter(gid=group)))
    lst = list(map(lambda param: {"aid": param.aid.aid, "name": param.aid.name, 
                                  "type": param.aid.get_type_display(),
                                  "private": param.aid.private, "category": param.aid.category,
                                  "capacity": param.aid.capacity, "maximum": param.aid.maximum,
                                  "picture": param.aid.picture.url if param.aid.picture else None,
                                  "start_time": param.start_time.strftime("%Y-%m-%d %H:%M:%S"),
                                  "end_time": param.end_time.strftime("%Y-%m-%d %H:%M:%S"),
                                  "favor": param.aid.favor},
                   ActivityUseField.objects.filter(aid__in=activities).order_by('-start_time')))
    print(lst)
    return JsonResponse({"msg": '活动信息获取成功', "status": True, "list": lst})
```



#### 3.2.3 活动模块

**创建活动**：

创建活动需要检查活动时间的合法性，根据场地ID到 `Field` 表查询场地开放时间进行比较，对于不允许同一时间段有多个活动的场地，还需要在 `ActivityUseField` 查找申请时段是否已经存在联系记录，如果有则表明场地已被占用。

检查完时间的合法性后，将活动基本信息填入 `Activity` 表中，并将申请用户与活动的联系添加到活动成员表。

对于个人活动，将创建信息填入到用户创建活动表中，对于团体活动将创建信息填入到团体创建活动表中。

```python
@require_http_methods(["POST"])
def create(request):
    """ 创建新的活动 """
    data = request.POST
    print(data)
    if int(data.get('maximum')) < 1:
        return JsonResponse({"msg": "活动人数至少为1", "status": False})
    # 检查场地是否被占用
    elif not activity_field.check_relation(data.get('fid'), data.get('start_time'), data.get('end_time')):
        return JsonResponse({"msg": "当前时段场地不开放或已被占用", "status": False})
    else:
        activity = Activity(aid=genid(), type=data.get('type'), name=data.get('name'), desc=data.get('desc'),
                            category=data.get('category'), tags=data.get('tags'), maximum=data.get('maximum'),
                            capacity=0, favor=0, private=data.get('private') == 'true',
                            picture=request.FILES['picture'])
        activity.save()
        # 添加场地使用记录
        activity_field.add_relation(activity.aid, data.get('fid'), data.get('start_time'), data.get('end_time'))

        # 添加创建信息
        if data.get('type') == '0':  # 个人
            user_activity.add_create_relation(data.get('uid'), activity.aid)
        elif data.get('type') == '1':  # 团体
            group_activity.add_create_relation(data.get('uid'), data.get('gid'), activity.aid)
        else:
            return JsonResponse({"msg": "type参数取值有误", "status": False})

        # 项目创建人参与活动
        user_activity.add_relation(data.get('uid'), activity.aid)
        return JsonResponse({"msg": "活动创建成功", "status": True})
```

**获取活动列表**：

这一过程为查询过程，允许用户以各种搜索条件获取活动列表。首先依据用户的搜索信息形成初步查询条件，`Activity` 与`ActivityUseField`自然连接，在表中查找尚未开始的活动，并且依据活动的开放属性，选择对用户可见的活动进行展示。

```python
@require_http_methods(["GET"])
def active(request):
    """ 查看当前可见的有效活动 """
    uid = request.GET.get('uid')
    time = request.GET.get('time', '')
    text = request.GET.get('text', '')
    category = request.GET.get('category', '')
    tag = request.GET.get('tag', '')
    activity_type = int(request.GET.get('type'))

    query = Q(start_time__gt=timezone.now())
    if time:
        query &= Q(start_time__date=parse_date(time))
    if text:
        query &= Q(Q(aid__name__icontains=text) | Q(aid__desc__icontains=text))
    if category:
        query &= Q(aid__category__icontains=category)
    if tag:
        query &= Q(aid__tags__icontains=tag)
    if activity_type != 2:
        query &= Q(aid__type__icontains=activity_type)
    records = ActivityUseField.objects.filter(query).order_by('start_time')
    lst = []
    groups = list(map(lambda param: param.gid, user_group.search_relation(uid, None)))
    actives = list((map(lambda param: param.aid, UserInActivity.objects.filter(uid=uid))))
    for record in records:
        flag = False
        if record.aid.type == 0:  # 个人
            if not record.aid.private or UserCreateActivity.objects.filter(aid=record.aid, uid=uid):
                flag = True
        elif record.aid.type == 1:  # 团体
            if not record.aid.private or GroupCreateActivity.objects.filter(aid=record.aid, gid__in=groups):
                flag = True

        if flag:
            lst.append({
                "aid": record.aid.aid,
                "name": record.aid.name,
                "type": record.aid.get_type_display(),
                "category": record.aid.category,
                "capacity": record.aid.capacity,
                "maximum": record.aid.maximum,
                "start_time": record.start_time.strftime("%Y-%m-%d %H:%M:%S"),
                "end_time": record.end_time.strftime("%Y-%m-%d %H:%M:%S"),
                "picture": record.aid.picture.url if record.aid.picture else None,
                "is_joined": record.aid in actives
            })

    return JsonResponse({"msg": "活动信息获取成功", "status": True, "list": lst})
```

**活动详情**：

这一过程将 `Activity` 表与 `UserInActivity` 表、`ActivityUseField`表作自然连接，查询指定活动的具体信息和参与成员信息。

```python
@require_http_methods(["GET"])
def detail(request):
    """ 查看活动的详细信息 """
    activity = Activity.objects.get(aid=request.GET.get('aid'))
    field_usage = ActivityUseField.objects.get(aid=activity)
    participants = list(
        map(lambda param: {"picture": param.uid.picture.url if param.uid.picture else None,
                           "uid": param.uid.uid, "user_name": param.uid.user_name,
                           "gender": param.uid.user_gender},
            UserInActivity.objects.filter(aid=activity))
    )
    data = {
        "aid": activity.aid,
        "type": activity.get_type_display(),
        "activity_name": activity.name,
        "desc": activity.desc,
        "category": activity.category,
        "tags": activity.tags.split('-'),
        "capacity": activity.capacity,
        "maximum": activity.maximum,
        "picture": activity.picture.url if activity.picture else None,
        "start_time": field_usage.start_time.strftime("%Y-%m-%d %H:%M:%S"),
        "end_time": field_usage.end_time.strftime("%Y-%m-%d %H:%M:%S"),
        "location": field_usage.fid.location,
        "favors": activity.favor,
        "participants": participants,
    }

    if activity.type == 0:  # 个人
        creation = UserCreateActivity.objects.get(aid=activity)
        data['uid'] = creation.uid.uid
        data['user_name'] = creation.uid.user_name
    else:  # 团体
        creation = GroupCreateActivity.objects.get(aid=activity)
        data['uid'] = creation.uid.uid
        data['user_name'] = creation.uid.user_name
        data['gid'] = creation.gid.gid
        data['group_name'] = creation.gid.group_name

    return JsonResponse({"msg": "活动详细信息获取成功", "status": True, "data": data})
```

**加入活动**：

这一过程和用户参加团体类似，在`Activity`表查看活动的成员数量是否已达到上限，是则返回错误信息，否则增加成员人数，并将用户-团体联系添加到`UserInGroup`表中。

```python
@require_http_methods(["POST"])
def join(request):
    """ 用户加入活动 """
    data: dict = json.loads(request.body)
    uid = data.get('uid')
    aid = data.get('aid')
    if user_activity.add_relation(uid, aid):
        return JsonResponse({"msg": "成功加入活动", "status": True})
    else:
        return JsonResponse({"msg": "人数已达上限", "status": False})
```

**退出活动**：

退出活动到 `Activity` 表找到数据项，判断用户是否为活动的创建者，如果不是则删除`UserInGroup`表的联系，如果是则将活动信息移除活动表，由于外键设置了级联删除，先关联系会一并清除，保证数据库数据的一致性。

```python
@require_http_methods(["POST"])
def exit_out(request):
    """ 用户退出、撤销活动 """
    data: dict = json.loads(request.body)
    uid = data.get('uid')
    aid = data.get('aid')
    user_activity.delete_relation(uid, aid)
    return JsonResponse({"msg": "活动已退出", "status": True})
```



#### 3.2.5 社区好友系统

**用户搜索**：

**申请好友**：

**处理好友申请**：

**获取好友列表**：

**删除好友**：

**发布活动动态**：

**获取动态列表**：



#### 3.2.6 器材借用系统

**获取器材列表**：

**租借器材**：

**归还器材**：



### 3.3 活动推荐





## 四、系统实现结果



## 五、总结