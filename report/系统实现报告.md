# 系统实现报告



## 一、系统结构设计

### 1.1 体系结构

此系统应用采用了前端、后端、数据库分离的体系结构。数据库层次负责存储、管理数据；后端层次根据前端请求，与数据库做交互，对数据库的数据进行增删改查，并进行处理，按需传给前端；前端层次根据后端传入的数据，展示渲染页面，并与用户交互，依据用户的操作向后端发送请求。

#### 1.1.1 系统实现环境

**前端**：



**后端**：采用 Django 框架，使用 Python 开发语言。

依赖包：

```
Django              4.2.6
django-cors-headers 4.3.0
mysqlclient         2.2.0
Pillow              10.1.0
PyMySQL             1.1.0
```

**数据库**：使用华为 GaussDB 云数据库，支持 MySQL 语法。

#### 1.1.2 前端结构



#### 1.1.3 后端结构

后端的文件结构如下：

```
├─api                 存放和数据库有关的代码
│  ├─ migrations      存放数据库迁移文件
│  ├─ system          存放系统配置函数，包括上传图片的重命名方法
│  └─ views           存放处理请求并返回响应的视图代码
│     ├─ entity       存放数据库实体表有关的代码
│     ├─ relation     存放数据库联系表有关的代码
│     └─ util         工具包
├─backend             Django 配置
└─media               保存上传的文件
    └─images          存放前端上传的图片
```



### 1.2 功能结构





<br>

## 二、数据库基本表的定义

在后端数据库实现中，我们选择采用 Django 中的 ORM 技术，在 `models.py` 文件中定义了 7 个实体表和 11 个联系表，这些表的结构和关系都通过类继承 `models.Model` 来定义，并且利用 ORM 提供的语法来定义了数据库表的类型、约束和关系。通过 ORM，能够以面向对象的方式来操作数据库，简化了数据库操作的编程过程，并提高了开发效率。

### 2.1 实体表

**用户表：**管理用户个人信息。

|  属性名  |     字段名     |   数据类型   |       约束       |
| :------: | :------------: | :----------: | :--------------: |
|    ID    |      uid       |     int      |   PRIMARY KEY    |
|   账号   |    account     | varchar(32)  | NOT NULL、UNIQUE |
|   密码   |    password    | varchar(32)  |     NOT NULL     |
|   姓名   |   user_name    | varchar(10)  |     NOT NULL     |
|   性别   |  user_gender   |   smallint   |     NOT NULL     |
|   年龄   |    user_age    |     int      |     NOT NULL     |
| 个人签名 | user_signature | varchar(128) |     NOT NULL     |
| 电话号码 |  phone_number  |    bigint    | NOT NULL、UNIQUE |
|   邮箱   |     email      | varchar(32)  | NOT NULL、UNIQUE |
|   头像   |    picture     | varchar(100) |                  |

```python
class User(models.Model):
    """ 用户实体表 """
    USER_GENDER = (
        (0, '女'),
        (1, '男'),
    )
    uid = models.IntegerField(primary_key=True)
    account = models.CharField(max_length=32, unique=True)
    password = models.CharField(max_length=32)
    user_name = models.CharField(max_length=10)
    user_age = models.IntegerField()
    user_gender = models.SmallIntegerField(choices=USER_GENDER)
    phone_number = models.BigIntegerField(unique=True)
    email = models.EmailField(max_length=32, unique=True)
    user_signature = models.CharField(max_length=128, default="", blank=True)
    picture = models.ImageField(upload_to='images/user/', storage=ImageStorage(), null=True)
```



**团体表：**管理团体的基本信息。

|  属性名  |   字段名   |   数据类型   |       约束       |
| :------: | :--------: | :----------: | :--------------: |
|    ID    |    gid     |     int      |   PRIMARY KEY    |
|   名称   | group_name | varchar(32)  | NOT NULL、UNIQUE |
|   描述   | group_desc | varchar(128) |     NOT NULL     |
| 团体图片 |  picture   | varchar(100) |                  |
| 人数限制 |  maximum   |     int      |     NOT NULL     |
| 成员人数 |  capacity  |     int      |     NOT NULL     |
|   标签   |    tag     | varchar(32)  |     NOT NULL     |
|  创建人  |  creator   |     int      |   FOREIGN KEY    |

```python
class Group(models.Model):
    """ 团体实体表 """
    gid = models.IntegerField(primary_key=True)
    creator = models.ForeignKey(User, on_delete=models.CASCADE)
    group_name = models.CharField(max_length=32, unique=True)
    group_desc = models.CharField(max_length=128)
    tag = models.CharField(max_length=32)
    maximum = models.IntegerField()
    capacity = models.IntegerField()
    picture = models.ImageField(upload_to='images/group/', storage=ImageStorage(), null=True)
```



**器材表：**管理器材实体的基本信息。

|  属性名  |  字段名  |   数据类型   |       约束       |
| :------: | :------: | :----------: | :--------------: |
|    ID    |   eid    |     int      |   PRIMARY KEY    |
|   类别   | category | varchar(32)  | NOT NULL、UNIQUE |
|   数量   |  amount  |     int      |     NOT NULL     |
| 器材图片 | picture  | varchar(100) |                  |

```python
class Equipment(models.Model):
    """ 器材实体表 """
    eid = models.IntegerField(primary_key=True)
    category = models.CharField(max_length=32, unique=True)
    amount = models.IntegerField(default=0)
    picture = models.ImageField(upload_to='images/equipment/', storage=ImageStorage(), null=True)
```



**场地表：**管理场地的基本信息。

|  属性名  |   字段名   |  数据类型   |       约束       |
| :------: | :--------: | :---------: | :--------------: |
|    ID    |    fid     |     int     |   PRIMARY KEY    |
|   位置   |  location  | varchar(32) | NOT NULL、UNIQUE |
|   类别   |  category  | varchar(16) |     NOT NULL     |
| 开始时间 | open_time  |   time(6)   |     NOT NULL     |
| 结束时间 | close_time |   time(6)   |     NOT NULL     |
| 项目限制 |   limit    | tinyint(1)  |     NOT NULL     |

```python
class Field(models.Model):
    """ 运动场地实体表 """
    fid = models.IntegerField(primary_key=True)
    location = models.CharField(max_length=32, unique=True)
    category = models.CharField(max_length=16, db_index=True)
    limit = models.BooleanField()
    open_time = models.TimeField()
    close_time = models.TimeField()
```



**活动表：**管理活动基本信息。

|    属性名    |    字段名    |   数据类型   |    约束     |
| :----------: | :----------: | :----------: | :---------: |
|      ID      |     aid      |     int      | PRIMARY KEY |
|   活动名称   |     name     | varchar(32)  |  NOT NULL   |
|   活动描述   |     desc     | varchar(128) |  NOT NULL   |
|   活动图片   |   picture    | varchar(100) |             |
| 活动人数限制 |   maximum    |     int      |  NOT NULL   |
|   参与人数   |   capacity   |     int      |  NOT NULL   |
|   活动类型   |   category   | varchar(32)  |  NOT NULL   |
|     标签     |     tags     | varchar(128) |  NOT NULL   |
|  创建者类型  | creator_type |   smallint   |  NOT NULL   |
|    获赞数    |    favor     |     int      |  NOT NULL   |
|    私有性    |   private    |  tinyint(1)  |  NOT NULL   |

```python
class Activity(models.Model):
    """ 活动项目实体表 """
    TYPE = (
        (0, "个人"),
        (1, "团体"),
    )
    aid = models.IntegerField(primary_key=True)
    type = models.SmallIntegerField(choices=TYPE, db_index=True)
    name = models.CharField(max_length=32, db_index=True)
    desc = models.CharField(max_length=128)
    category = models.CharField(max_length=32, db_index=True)
    tags = models.CharField(max_length=128)
    maximum = models.IntegerField()
    capacity = models.IntegerField()
    favor = models.IntegerField()
    picture = models.ImageField(upload_to='images/activity/', storage=ImageStorage(), null=True)
    private = models.BooleanField()
```



**通知表：**管理系统通知的基本数据。

|  属性名  |  字段名  |   数据类型   |    约束     |
| :------: | :------: | :----------: | :---------: |
|    ID    |   nid    |     int      | PRIMARY KEY |
| 通知时间 |   time   | datetime(6)  |  NOT NULL   |
| 通知内容 |   text   | varchar(128) |  NOT NULL   |
| 通知对象 | receiver |     int      | FOREIGN KEY |

```python
class Notice(models.Model):
    """ 系统通知表 """
    nid = models.IntegerField(primary_key=True)
    time = models.DateTimeField(auto_now_add=True, db_index=True)
    text = models.CharField(max_length=128)
    receiver = models.ForeignKey(User, on_delete=models.CASCADE)
```



**动态表：**管理用户发表的动态信息。

|  属性名  |  字段名  |   数据类型   |    约束     |
| :------: | :------: | :----------: | :---------: |
|    ID    |   sid    |     int      | PRIMARY KEY |
| 发布时间 |   time   | datetime(6)  |  NOT NULL   |
| 发布文本 |   text   | varchar(512) |  NOT NULL   |
| 发布图片 | picture  | varchar(100) |             |
|  获赞数  |  favor   |     int      |  NOT NULL   |
|  私有性  | private  |   smallint   |  NOT NULL   |
| 所属用户 |   user   |     int      | FOREIGN KEY |
| 关联活动 | activity |     int      | FOREIGN KEY |

```python
class Stream(models.Model):
    """ 动态表 """
    PRIVACY = (
        (0, "仅自己可见"),
        (1, "好友可见"),
        (2, "所有人可见"),
    )
    sid = models.IntegerField(primary_key=True)
    time = models.DateTimeField(auto_now_add=True, db_index=True)
    text = models.CharField(max_length=512)
    picture = models.ImageField(upload_to='images/stream/', storage=ImageStorage(), null=True)
    favor = models.IntegerField(default=0)
    private = models.SmallIntegerField(choices=PRIVACY)
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    activity = models.ForeignKey(Activity, on_delete=models.CASCADE)
```



### 2.2 联系表

由于 ORM 不支持多个字段共同作为主键，因此没有指定主键的表会自动添加一个自增的 id 字段。

**团体成员表：**记录团体的成员信息。

|  属性名  | 字段名 | 数据类型 |            约束             |
| :------: | :----: | :------: | :-------------------------: |
|    ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
|  用户ID  |  uid   |   int    |         FOREIGN KEY         |
|  团体ID  |  gid   |   int    |         FOREIGN KEY         |
| 成员类型 |  type  | smallint |          NOT NULL           |

 `(uid, gid)` 组合添加了唯一约束。

```python
class UserInGroup(models.Model):
    """ 用户从属团体联系表 """
    TYPE = (
        (0, "创建人"),
        (1, "管理员"),
        (2, "成员"),
    )
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    type = models.SmallIntegerField(choices=TYPE)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'gid'], name='unique_user_in_group'),
        ]
```



**团体申请表：**记录团体的申请信息与审批情况。

|  属性名  |   字段名   |   数据类型   |            约束             |
| :------: | :--------: | :----------: | :-------------------------: |
|    ID    |     id     |    bigint    | PRIMARY KEY、AUTO_INCREMENT |
|  用户ID  |    uid     |     int      |         FOREIGN KEY         |
|  团体ID  |    gid     |     int      |         FOREIGN KEY         |
| 申请内容 |  content   | varchar(128) |          NOT NULL           |
| 申请时间 | apply_time | datetime(6)  |          NOT NULL           |
| 申请状态 |   status   |   smallint   |          NOT NULL           |

`(uid, gid, apply_time)` 组合添加了唯一约束。

```python
class UserApplyGroup(models.Model):
    """ 用户申请团体联系表 """
    STATUS = (
        (0, "申请中"),
        (1, "已接受"),
        (2, "已拒绝"),
    )
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    content = models.CharField(max_length=128)
    apply_time = models.DateTimeField(auto_now_add=True, db_index=True)
    status = models.SmallIntegerField(choices=STATUS)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'gid', 'apply_time'], name='unique_user_apply_group'),
        ]
```



**场地使用情况表：**记录活动和场地的联系与相关信息。

|  属性名  |   字段名   |  数据类型   |            约束             |
| :------: | :--------: | :---------: | :-------------------------: |
|    ID    |     id     |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|  活动ID  |    aid     |     int     |         FOREIGN KEY         |
|  场地ID  |    fid     |     int     |         FOREIGN KEY         |
| 起始时间 | start_time | datetime(6) |          NOT NULL           |
| 结束时间 |  end_time  | datetime(6) |          NOT NULL           |

`aid`、`(fid, start_time)` 组合和 `(fid, end_time) `组合添加了唯一约束。

```python
class ActivityUseField(models.Model):
    """ 活动使用场地联系表"""
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE)
    fid = models.ForeignKey(Field, on_delete=models.CASCADE)
    start_time = models.DateTimeField(db_index=True)
    end_time = models.DateTimeField(db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_activity_user_field1'),
            models.UniqueConstraint(fields=['fid', 'start_time'], name='unique_activity_user_field2'),
            models.UniqueConstraint(fields=['fid', 'end_time'], name='unique_activity_user_field3')
        ]
```



**用户参加活动记录表：**记录活动的参与成员。

| 属性名 | 字段名 |  数据类型  |            约束             |
| :----: | :----: | :--------: | :-------------------------: |
|   ID   |   id   |   bigint   | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |    int     |         FOREIGN KEY         |
| 活动ID |  aid   |    int     |         FOREIGN KEY         |
|  喜欢  |  like  | tinyint(1) |          NOT NULL           |

`(uid, aid)` 组合添加了唯一约束。

```python
class UserInActivity(models.Model):
    """ 用户参加项目联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE, db_index=True)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)
    like = models.BooleanField()

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'aid'], name='unique_user_in_activity')
        ]
```



**用户创建活动记录表：**记录个人活动的创建信息。

| 属性名 | 字段名 | 数据类型 |            约束             |
| :----: | :----: | :------: | :-------------------------: |
|   ID   |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |   int    |         FOREIGN KEY         |
| 活动ID |  aid   |   int    |         FOREIGN KEY         |

`aid`字段添加了唯一约束。

```python
class UserCreateActivity(models.Model):
    """ 用户发起活动联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_user_create_activity')
        ]
```



**团体创建活动记录表：**记录团体活动的创建信息。

|  属性名  | 字段名 | 数据类型 |            约束             |
| :------: | :----: | :------: | :-------------------------: |
|    ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
|  团体ID  |  gid   |   int    |         FOREIGN KEY         |
| 创建人ID |  uid   |   int    |         FOREIGN KEY         |
|  活动ID  |  aid   |   int    |         FOREIGN KEY         |

`aid`字段添加了唯一约束。

```python
class GroupCreateActivity(models.Model):
    """ 团体发起活动联系表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE)
    aid = models.ForeignKey(Activity, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['aid'], name='unique_group_create_activity')
        ]
```



**用户器材借用表：**记录个人借用器材的相关信息。

|    属性名    |   字段名    |  数据类型   |            约束             |
| :----------: | :---------: | :---------: | :-------------------------: |
|      ID      |     id      |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|    器材ID    |     eid     |     int     |         FOREIGN KEY         |
|    用户ID    |     uid     |     int     |         FOREIGN KEY         |
| 借用开始时间 | start_time  | datetime(6) |          NOT NULL           |
| 借用结束时间 |  end_time   | datetime(6) |          NOT NULL           |
|   是否归还   |  is_return  |  smallint   |          NOT NULL           |
|   借用数量   | lend_amount |     int     |          NOT NULL           |

`(eid, uid, start_time, end_time)`组合添加了唯一约束。

```python
class UserEquipment(models.Model):
    """ 用户借用器材联系表 """
    RETURN_STATUS = (
        (0, "未归还"),
        (2, "已归还"),
    )
    eid = models.ForeignKey(Equipment, on_delete=models.CASCADE)
    uid = models.ForeignKey(User, on_delete=models.CASCADE, db_index=True)
    start_time = models.DateTimeField()
    end_time = models.DateTimeField()
    lend_amount = models.IntegerField()
    is_return = models.SmallIntegerField(choices=RETURN_STATUS, default=0)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['eid', 'uid', 'start_time', 'end_time'], name='unique_user_equipment')
        ]
```



**团体器材借用表：**记录团体借用器材的相关信息。

|    属性名    |   字段名    |  数据类型   |            约束             |
| :----------: | :---------: | :---------: | :-------------------------: |
|      ID      |     id      |   bigint    | PRIMARY KEY、AUTO_INCREMENT |
|    器材ID    |     eid     |     int     |         FOREIGN KEY         |
|    团体ID    |     gid     |     int     |         FOREIGN KEY         |
| 借用开始时间 | start_time  | datetime(6) |          NOT NULL           |
| 借用结束时间 |  end_time   | datetime(6) |          NOT NULL           |
|   是否归还   |  is_return  |  smallint   |          NOT NULL           |
|   借用数量   | lend_amount |     int     |          NOT NULL           |

`(eid, gid, start_time, end_time)`组合添加了唯一约束。

```python
class GroupEquipment(models.Model):
    """ 团体借用器材联系表 """
    RETURN_STATUS = (
        (0, "未归还"),
        (2, "已归还"),
    )
    eid = models.ForeignKey(Equipment, on_delete=models.CASCADE)
    gid = models.ForeignKey(Group, on_delete=models.CASCADE, db_index=True)
    start_time = models.DateTimeField()
    end_time = models.DateTimeField()
    lend_amount = models.IntegerField()
    is_return = models.SmallIntegerField(choices=RETURN_STATUS, default=0)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['eid', 'gid', 'start_time', 'end_time'], name='unique_group_equipment')
        ]
```



**好友联系表：**记录用户-用户好友联系。

| 属性名  | 字段名 | 数据类型 |            约束             |
| :-----: | :----: | :------: | :-------------------------: |
|   ID    |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID1 |  uid1  |   int    |         FOREIGN KEY         |
| 用户ID2 |  uid2  |   int    |         FOREIGN KEY         |

`(uid1, uid2)`组合添加了唯一约束。

```python
class Friend(models.Model):
    """ 好友联系表 """
    uid1 = models.ForeignKey(User, on_delete=models.CASCADE, related_name='friends1')
    uid2 = models.ForeignKey(User, on_delete=models.CASCADE, related_name='friends2')

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid1', 'uid2'], name='unique_friend')
        ]
```



**好友申请表：**记录好友申请信息和审批状态。

|  属性名  |   字段名   |   数据类型   |            约束             |
| :------: | :--------: | :----------: | :-------------------------: |
|    ID    |     id     |    bigint    | PRIMARY KEY、AUTO_INCREMENT |
| 申请者ID |   sender   |     int      |         FOREIGN KEY         |
| 接收者ID |  receiver  |     int      |         FOREIGN KEY         |
| 申请内容 |  content   | varchar(128) |          NOT NULL           |
| 申请时间 | apply_time | datetime(6)  |          NOT NULL           |
| 申请状态 |   status   |   smallint   |          NOT NULL           |

`(sender, receiver, apply_time)`组合添加了唯一约束。

```python
class FriendApply(models.Model):
    """ 好友申请表 """
    STATUS = (
        (0, "申请中"),
        (1, "已接受"),
        (2, "已拒绝"),
    )
    sender = models.ForeignKey(User, on_delete=models.CASCADE, related_name='sender')
    receiver = models.ForeignKey(User, on_delete=models.CASCADE, related_name='receiver')
    content = models.CharField(max_length=128)
    apply_time = models.DateTimeField(auto_now_add=True, db_index=True)
    status = models.SmallIntegerField(choices=STATUS)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['sender', 'receiver', 'apply_time'], name='unique_friend_apply')
        ]
```



**动态点赞记录表：**记录用户点赞动态的先关信息。

| 属性名 | 字段名 | 数据类型 |            约束             |
| :----: | :----: | :------: | :-------------------------: |
|   ID   |   id   |  bigint  | PRIMARY KEY、AUTO_INCREMENT |
| 用户ID |  uid   |   int    |         FOREIGN KEY         |
| 动态ID |  sid   |   int    |         FOREIGN KEY         |

 `(uid, sid)` 组合添加了唯一约束。

```python
class UserFavorStream(models.Model):
    """ 用户点赞动态记录表 """
    uid = models.ForeignKey(User, on_delete=models.CASCADE)
    sid = models.ForeignKey(Stream, on_delete=models.CASCADE, db_index=True)

    class Meta:
        constraints = [
            models.UniqueConstraint(fields=['uid', 'sid'], name='unique_user_favor_stream')
        ]
```



## 三、系统重要功能实现方法

### 3.1 触发器

合理使用数据库触发器可以防⽌产生异常数据。本项目中主要对删除操作设置触发器，保证数据的完整性和一致性。



### 3.2 存储过程

数据库数据的增删改仅涉及到 `POST` 接口，故本部分主要列出 `POST` 接口对应的数据库存储过程的逻辑，同时也包括一些重要的 `GET` 接口的实现逻辑。

#### 3.2.1 用户管理

**注册**：

这一过程获取前端传来的数据，在 `User` 表中检查电话号码、邮箱、账号的唯一约束。如果错误则返回错误信息，否则随机生成唯一的 ID 填入 `User` 表中。

```python
@require_http_methods(["POST"])
def register(request):
    """ 用户注册 """
    data: dict = json.loads(request.body)
    account = data.get('account')
    phone_number = data.get("phone_number")
    email = data.get("email")
    if User.objects.filter(account=account).first():
        return JsonResponse({"msg": "账号已被注册", "status": False, "uid": "", "user_name": ""})
    elif User.objects.filter(Q(phone_number=phone_number) | Q(email=email)).first():
        return JsonResponse({"msg": "电话或邮箱已被注册", "status": False, "uid": "", "user_name": ""})
    else:
        uid = genid()
        password = data.get('password')
        user_name = data.get('user_name')
        user_age = data.get("user_age")
        user_gender = data.get("user_gender")
        user_signature = ""
        new_user = User(uid=uid, account=account, password=password, user_name=user_name,
                        user_age=user_age, user_gender=user_gender, phone_number=phone_number,
                        email=email, user_signature=user_signature)
        new_user.save()
        return JsonResponse({"msg": "注册成功", "status": True, "uid": uid, "user_name": user_name})
```

**登录**：

这一过程根据用户输入的账号密码，查找`User`表是否有匹配的数据项，并将基本的用户信息返回给前端。

```python
@require_http_methods(["GET"])
def login(request):
    """ 用户登录验证 """
    account = request.GET.get('account')
    password = request.GET.get('password')
    user = User.objects.filter(account=account, password=password).first()
    if user:
        return JsonResponse({"msg": '登录成功', "status": True, "uid": user.uid, "user_name": user.user_name,
                             "picture": user.picture.url if user.picture else None})
    else:
        return JsonResponse({"msg": '登录失败', "status": False, "uid": None, "user_name": None})
```

**修改个人信息**：

这一过程用于修改用户个人的信息，由于用户输入的数据并不确定，为了保证数据库约束完整，需要对用户修改的电话号码、邮箱信息进行检查，如果已存在则返回错误，否则将新的数据写入`User`表对应表项中。

```python
@require_http_methods(["POST"])
def modify_text(request):
    """ 修改个人信息 """
    req: dict = json.loads(request.body)
    print(req)
    user = User.objects.get(uid=req.get('uid'))
    # 数据库约束检查
    phone_number = req.get('data').get('phone_number')
    email = req.get('data').get('email')
    if phone_number and phone_number != user.phone_number:
        if User.objects.filter(phone_number=phone_number).first():
            return JsonResponse({"msg": "电话号码已存在", "status": False})
    if email and email != user.email:
        if User.objects.filter(email=email).first():
            return JsonResponse({"msg": "邮箱已存在", "status": False})

    for (key, value) in req.get('data').items():
        print(key, value)
        setattr(user, key, value)
    user.save()
    return JsonResponse({"msg": "个人信息修改成功", "status": True})
```

**上传用户头像**：

利用 Django 框架上传用户头像，将图片路径存入到 `User` 表的 `picture` 字段里。

```python
@require_http_methods(["POST"])
def modify_pic(request):
    """ 修改个人头像 """
    print(request.POST)
    user = User.objects.get(uid=request.POST.get('uid'))
    user.picture = request.FILES['picture']
    user.save()
    return JsonResponse({"msg": "头像已更新", "status": True})
```

**获取用户参加的团体**：

`UserInGroup` 表和 `Group `表依据团体 ID 进行自然连接，以用户 ID 查找相关数据项，并把团体的基本信息以数组形式返回给前端进行展示。

```python
@require_http_methods(["GET"])
def group_list(request):
    """ 查看用户所属团体 """
    uid = request.GET.get('uid')
    lst = list(map(lambda param: {'gid': param.gid.gid, 'group_name': param.gid.group_name,
                                  'group_desc': param.gid.group_desc, 'tag': param.gid.tag,
                                  'capacity': param.gid.capacity, 'maximum': param.gid.maximum,
                                  'creator': param.gid.creator.user_name,
                                  'pic': param.gid.picture.url if param.gid.picture else None,
                                  "type": param.get_type_display()},
                   user_group.search_relation(uid, None)))
    print(lst)
    return JsonResponse({"msg": '团体信息请求成功', "status": True, "list": lst})
```

**获取用户参加的活动**：

`UserInActivity` 表、 `Activity` 表和`ActivityUseField`表按照活动 ID 进行自然连接，以用户 ID 查找相关数据项。将查询结果的活动基本信息以数组形式返回给前端进行展示。

```python
@require_http_methods(["GET"])
def activity_list(request):
    """ 查看用户参加的活动 """
    uid = request.GET.get('uid')
    user = User.objects.get(uid=uid)
    activities = set()
    liked_activities = set()
    for rec in UserInActivity.objects.filter(uid=user):
        if rec.like:
            liked_activities.add(rec.aid)
        activities.add(rec.aid)
    lst = list(map(lambda param: {"aid": param.aid.aid, "name": param.aid.name, 
                                  "type": param.aid.get_type_display(),
                                  "private": param.aid.private, "category": param.aid.category,
                                  "capacity": param.aid.capacity, "maximum": param.aid.maximum,
                                  "picture": param.aid.picture.url if param.aid.picture else None,
                                  "start_time": param.start_time.strftime("%Y-%m-%d %H:%M:%S"),
                                  "end_time": param.end_time.strftime("%Y-%m-%d %H:%M:%S"),
                                  "favor": param.aid.favor, "is_favor": param.aid in liked_activities},
                   ActivityUseField.objects.filter(aid__in=activities).order_by('-start_time')))
    print(lst)
    return JsonResponse({"msg": '活动信息获取成功', "status": True, "list": lst})
```



#### 3.2.2 团体模块

**创建团体**：

这一过程检查`Group`表中团体名的唯一性约束是否满足，如果失败则返回错误信息，成功则插入新的团体信息，并且将团体创建者 ID 和 团体 ID 的联系填入 `UserInGroup` 表中。

```python
def create(request):
    """ 用户创建团体 """
    if request.method == 'POST':
        data = request.POST
        print(data)
        uid = data.get("uid")
        group_name = data.get("group_name")
        group_desc = data.get("group_desc")
        maximum = data.get("maximum")
        tag = data.get("tag")

        if Group.objects.filter(group_name=group_name):
            return JsonResponse({"msg": "团体名称已被使用", "status": False})
        else:
            # 添加团体信息
            gid = genid()
            creator = User.objects.get(uid=uid)
            new_group = Group(gid=gid, creator=creator, group_name=group_name, group_desc=group_desc,
                              tag=tag, maximum=maximum, capacity=0, picture=request.FILES['picture'])
            new_group.save()
            # 添加用户团体联系
            user_group.add_relation(uid, gid, 0)
            return JsonResponse({"msg": "团体创建成功", "status": True, "group_name": group_name, "gid": gid})
    else:
        return JsonResponse({"msg": "请求方式有误", "status": False})
```

**查看团体**：

这一过程允许用户通过关键字搜索，因此在 `Group` 表中按照类似于 ` MySQL` 中的 `in` 运算符进行模糊搜索，将获取的团体基本信息以列表的形式返回给前端。

```python
@require_http_methods(["GET"])
def view(request):
    """ 用户查看团体中心综述 """
    key = request.GET.get('keyword') or ''
    uid = request.GET.get('uid')
    groups = Group.objects.filter(
        Q(group_name__icontains=key) | Q(group_desc__icontains=key) | Q(tag__icontains=key)
    )
    joined_groups = list(map(lambda param: param.gid.gid, user_group.search_relation(uid, None)))

    lst = list(map(lambda param: {"gid": param.gid, "group_name": param.group_name, 
                                  "group_desc": param.group_desc,
                                  "tag": param.tag, "capacity": param.capacity, "maximum": param.maximum,
                                  "creator": param.creator.user_name, "is_joined": param.gid in joined_groups,
                                  "pic": param.picture.url if param.picture else None},
                   groups))

    return JsonResponse({"msg": "团体信息请求成功", "status": True, "list": lst})
```

**申请加入团体**：

```python
```

**审批团体申请**：

**退出团体**：

**移除成员**：

**修改成员权限**：

**查看团体活动**：



#### 3.2.3 活动模块

**创建活动**：

**获取活动列表**：

**活动详情**：

**加入活动**：

**退出活动**：

**活动点赞**：



#### 3.2.5 社区好友系统

**用户搜索**：

**申请好友**：

**处理好友申请**：

**获取好友列表**：

**删除好友**：

**发布活动动态**：

**获取动态列表**：



#### 3.2.6 器材借用系统

**获取器材列表**：

**租借器材**：

**归还器材**：



## 四、系统实现结果



## 五、总结